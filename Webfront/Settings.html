<!DOCTYPE html>
<html lang="en">
<head>
    <title>Settings - Digital Garden</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="Scripts/FlippyTextReader.js"></script>
    <link href="Style/Skeleton/skeleton.css" rel="stylesheet">
    <link href="Style/Skeleton/normalize.css" rel="stylessheet">
    <link href="Style/Style.css" rel = "stylesheet">
    <link href="Style/IconStyles.css" rel = "stylesheet">

    <script src="Scripts/userSession.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2/webcomponents-loader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="Scripts/config.js"></script>
    <script src="Scripts/LightDarkMode.js"></script>
    <script src="Scripts/NavControlls.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/SH20RAJ/ShowdownCSS@main/showdown.css">
</head>
<body class="LightMode" id="body">
    <div class="MainTitle">
        <h1 id="Title"></h1>
        
        <div id="UserSession"></div>
    </div>
    <div class="SideNav">
        <ul id="SideNavUL">

        </ul>
    </div>
    <div class="container MainBody" > 
        <div class="Row">
            <div class="twelve columns UserSettings">
                <div>
                    <h2>Settings</h2>
                </div>

                <img id="UserIcon" class='UserIcon' src='Style/Images/DefaultUserProfile.png'>
                <h2 id="Alias"></h2>
                <h4 id="UsernameDisplay"></h4>
                <hr>
                <ul>
                    <li>
                        Toggle Light Mode
                        <button class="ModeSwitch" onclick="ToggleDarkMode()">Light/Dark</button>
                    </li>
                    <li class="link" onclick="window.location.href='UserDetails.html'">
                        Edit User Profile
                    </li>
                    <li class="link" onclick="window.location.href='Drafts.html'">
                        Drafts
                    </li>
                    <li>
                        Create Invite Link
                        <div class="CreateInviteLink">
                            <input id="InviteLink" readonly>
                            <button onclick="CreateShareLink()">Create Link</button>
                        </div>
                    </li>
                </ul>
                <hr>
                <ul>
                    <li class="link logout" onclick="ClearLogin()">
                        Logout
                     </li>
                </ul>
            </div>            
        </div>
    </div>
</body>
<footer id="footer">

</footer>
<script>

    $('#UserDetailsForm').submit(function (e) {
        e.preventDefault();
        var fd = new FormData($(this)[0]);
        $.ajax({
            url: `http://${CONFIG.nodeserver}:${CONFIG.nodeport}/UserModification`,
            data: fd,
            processData: false,
            contentType: false,
            type: 'POST',
            success: function(data){
                console.log(data);
            }
        });
    });

    $session = {
        UserID:""
    }


    $(document).ready(function() {
        // check login
        checkLogin().then(result => {
            if(!result){
                window.location.href = "/"
            }
        })        
        
        $("#footer").load("footer.html");

        //get user details
       
        GetUserDetails(GetUserSession()).then(result => {
            //fill in user details
            document.getElementById('Alias').innerHTML = result.UserData.Alias
            document.getElementById('UsernameDisplay').innerHTML = result.Username
            document.getElementById("UserIcon").src = `http://${CONFIG.nodeserver}:${CONFIG.nodeport}/GetUserPfp?SessionID=${GetUserSession()}`
        });


        async function GetUserDetails(UserID) {
            const response = await fetch(`http://${CONFIG.nodeserver}:${CONFIG.nodeport}/GetUserDetails`, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                method: "POST",
                body: JSON.stringify({
                    SessionID : UserID,
                })
            });

            return response.json()
        }
    })

    function CreateShareLink(){

        async function getLink(){
            const response = await fetch(`http://${CONFIG.nodeserver}:${CONFIG.nodeport}/CreateInvite?SessionID=${GetUserSession()}`, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: "GET"
            })

            return response.json()
        }
        

        getLink().then(result => {
            if(!result.error){
                document.getElementById("InviteLink").value = result.InviteLink
            }
            else{
                alert(result.msg)
            }
        })

        

    }

</script>
</html>