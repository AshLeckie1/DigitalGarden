<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="Scripts/FlippyTextReader.js"></script>
    <link href="Style/Skeleton/skeleton.css" rel="stylesheet">
    <link href="Style/Skeleton/normalize.css" rel="stylessheet">
    <link href="Style/Style.css" rel = "stylesheet">
    <link href="Style/IconStyles.css" rel = "stylesheet">

    <script src="Scripts/userSession.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2/webcomponents-loader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="Scripts/config.js"></script>
    <script src="Scripts/userPopup.js"></script>
    <script src="Scripts/PostLayout.js"></script>
    <script src="Scripts/LightDarkMode.js"></script>
    <script src="Scripts/NavControlls.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/SH20RAJ/ShowdownCSS@main/showdown.css">
</head>
<body class="LightMode" id="body">
    <div class="MainTitle">
        <h1 id="Title"></h1>
        <div id="UserSession"></div>
    </div>
   <div class="SideNav">
        <ul id="SideNavUL">

        </ul>
    </div>
    <div class="container MainBody" id="MainBody" > 
        <div id="EditUserPage" hidden>
            <form method="post"  enctype="multipart/form-data" id="SetUserBackgroundForm" >
                <h4>Edit Page</h4>
                <h4 class="close" onclick="ToggleImageUpload()">âœ•</h4>
                <label>Background Image</label>    
                <input type="file" name="BackgroundImage" id="BackgroundImage">
                <input value="" name="SessionID" id="EditPageSessionID" hidden>
                <button type="submit">Upload</button>
            </form>
            <label>Remove Background Image</label>
            <button onclick="RemoveBackground()">Remove Image</button>
        </div>
        <div class="Row UserPageDetails">
            <div class="two columns ">
                <img id="UserIcon" class='UserIcon' src='Style/Images/DefaultUserProfile.png'>
            </div>   
            <div class="eight columns " id="UserDetails">
                <h2 id="Alias"></h2>
                <div id="bio"></div>
            </div>
            <div class="two columns" id="WhereTheEditButtonGoes">

            </div>
            <div class="twelve columns ">
                <div class="LinkPreview" id="UserLinks"></div>
            </div>
        </div>
        
        <div class="Row">
            <div class="twelve columns">
                <div id="Feed">
                </div>
            </div>            
        </div>
    </div>
</body>
<footer id="footer">
</footer>
<script>

    $session = {
        postPos:0,
        UserID:""

    }

    $('#SetUserBackgroundForm').submit(function (e) {
        e.preventDefault();
        var fd = new FormData($(this)[0]);
        $.ajax({
            url: `http://${CONFIG.nodeserver}:${CONFIG.nodeport}/SetUserBackground`,
            data: fd,
            processData: false,
            contentType: false,
            type: 'POST',
            success: function(data){
                console.log(data);
                alert("Changes Saved!")
                window.location.reload()
            }
        });
    });



    $(document).ready(function() {
        
        $("#footer").load("footer.html");
        //set site title
        TitleLoop()
        function TitleLoop(){
            TriggerChange("Title")
            setTimeout(TitleLoop,10000)
        }

        if(new URL(window.location.href).searchParams.get("ID") != null){
            //get user ID
            $session.UserID = new URL(window.location.href).searchParams.get("ID")

            //get feed
            GetFeed(0)

            //set user background image
            document.getElementById("body").style = `
            background-image:url('http://${CONFIG.nodeserver}:${CONFIG.nodeport}/GetUserBackground?Username=${$session.UserID}');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            `
        }else{
            alert("User not found!")
            window.location.href = "index.html"
        }

        // check login
        checkLogin().then(result => {
            if(result){
                GetUserDetails().then(UserDetails =>{
                    if(UserDetails.Username == $session.UserID){
                    document.getElementById("WhereTheEditButtonGoes").innerHTML += `<button onclick="ToggleImageUpload()">Edit</button>`

                    //document.getElementById("SetUserBackgroundForm").action=`http://${CONFIG.nodeserver}:${CONFIG.nodeport}/SetUserBackground`
                    document.getElementById('EditPageSessionID').value = GetUserSession()
                } 
                })
            }
        })        
    })

    function ToggleImageUpload(){
         var x = document.getElementById("EditUserPage");
        if (x.hidden == true) {
            x.hidden = false;
        } else {
            x.hidden = true;
        }
    }

    function RemoveBackground(){
        RemoveUserBackground().then(result => {
            if(!result.error){
                alert("Background Removed!")
                window.location.reload()
            }else{
                alert("There was an Error :(")
            }
        })
    }


    async function RemoveUserBackground() {
        const response = await fetch(`http://${CONFIG.nodeserver}:${CONFIG.nodeport}/RemoveUserBackground`, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: "POST",
            body: JSON.stringify({"SessionID":GetUserSession()})
        });
    
        return await response.json()
    }



    async function GetUserDetails() {
        const response = await fetch(`http://${CONFIG.nodeserver}:${CONFIG.nodeport}/checkLogin`, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: "POST",
            body: JSON.stringify({"SessionID":GetUserSession()})
        });
    
        return await response.json()
    }

    function GetFeed(pos){
        PostGetFeed(pos).then(feed => {
            console.log(feed)

            document.title = `${feed.userInfo.Alias} - Digital Garden`
            document.getElementById('Alias').innerHTML = feed.userInfo.Alias
            document.getElementById("UserIcon").src = `http://${CONFIG.nodeserver}:${CONFIG.nodeport}/GetUserPfp?UserID=${feed.userID}`
            document.getElementById('bio').innerHTML = feed.userInfo.Bio
           

            var Links = ""

            feed.userInfo.Links.forEach(link =>{
                Links += `
                <div onclick="window.open('${link.Link}${link.Username}')" class="${link.Title} link">   
                        <div class="IconContainer">
                            <img class="${link.Title}" src="Style/Images/SocialIconsSet.png">
                        </div>
                        <div class="Username">
                            ${link.Username}
                        </div>
                </div>`
            });

            document.getElementById("UserLinks").innerHTML = Links

            try{
                document.getElementById("NoPostDiv").remove()
            }catch{}
            

            if(feed.posts.length == 0){
                document.getElementById("Feed").innerHTML += `<dir class='NoPosts' id='NoPostDiv'><div><span>No posts found :( <br></span><br><button onclick='GetFeed(${$session.postPos})'>Refresh</button></div></div>`
            }

            feed.posts.forEach(post => {
                    document.getElementById("Feed").innerHTML += CreatePost(post)  
                    
            });

            $session.postPos = $session.postPos + feed.posts.length

            if(feed.posts.length > 0){
                document.getElementById("Feed").innerHTML += `<dir class='NoPosts' id='NoPostDiv'><button onclick='GetFeed(${$session.postPos})'>Get More Posts</button></div></div>`
                
            }

        })
        
        async function GetPost(PostID) {
            const response = await fetch(`http://${CONFIG.nodeserver}:${CONFIG.nodeport}/GetPost`, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                method: "POST",
                body: JSON.stringify({
                    PostID : PostID,
                })
            });

            return response.json()
        }

        async function PostGetFeed(pos) {
            const response = await fetch(`http://${CONFIG.nodeserver}:${CONFIG.nodeport}/GetFeedByUser`, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                method: "POST",
                body: JSON.stringify({
                    pos : pos,
                    UserID : $session.UserID 
                })
            });

            return response.json()
        }
    }

    function uuidv4() {
        return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
            (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
        );
    }

</script>
</html>